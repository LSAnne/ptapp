<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PT Portal · Trainer Sign‑Up</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0d10; --panel:#141820; --text:#eaf2f9; --muted:#92a4b6;
      --primary:#3b82f6; --danger:#ef4444; --border:#283142;
    }
    body{ background:var(--bg); color:var(--text); min-height:100vh; display:grid; place-items:center; }
    .card{ background:linear-gradient(180deg,#151a22,#11161e); border:1px solid var(--border); color:var(--text); box-shadow:0 20px 50px rgba(0,0,0,.35); }
    .form-control{ background:#0f141b; border:1px solid #2a3344; color:var(--text); }
    .form-control::placeholder{ color:#7f93a4; }
    .btn-primary{ background:var(--primary); border-color:var(--primary); font-weight:700; }
    .btn-link{ color:var(--muted); text-decoration:none; }
    .btn-link:hover{ text-decoration:underline; }
    .small-muted{ color:var(--muted); font-size:.9rem; }
    .error{ color:#ffd2d2; background:#3a1518; border:1px solid #53252a; padding:.6rem .75rem; border-radius:.5rem; display:none; }
    .ok{ color:#d7ffe1; background:#12341f; border:1px solid #1f5131; padding:.6rem .75rem; border-radius:.5rem; display:none; }
  </style>
</head>
<body>
  <a href="index.html" class="position-absolute top-0 start-0 m-3 btn btn-sm btn-outline-light">← Back to site</a>

  <div class="card p-4" style="width:min(520px, 92vw);">
    <h1 class="h4 mb-3">PT Portal · Trainer Sign‑Up</h1>

    <div id="msgOk" class="ok mb-3"></div>
    <div id="msgErr" class="error mb-3"></div>

    <form id="signupForm" novalidate>
      <div class="mb-3">
        <label class="form-label">Full name</label>
        <input id="full_name" type="text" class="form-control" placeholder="Jane Trainer" required />
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input id="email" type="email" class="form-control" placeholder="you@example.com" required />
      </div>
      <div class="mb-4">
        <label class="form-label">Password</label>
        <input id="password" type="password" class="form-control" placeholder="At least 6 characters" minlength="6" required />
      </div>
      <button id="submitBtn" class="btn btn-primary w-100" type="submit">Create trainer account</button>
    </form>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <button id="resetSession" class="btn btn-link p-0 small-muted">Reset cached session</button>
      <a class="btn btn-link p-0 small-muted" href="trainer-login.html">Already have an account? Sign in</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 1) Supabase init
    const SB_URL  = 'YOUR_SUPABASE_URL';
    const SB_ANON = 'YOUR_SUPABASE_ANON_KEY';
    const sb = window.sb = window.supabase.createClient(SB_URL, SB_ANON);

    const $ = (q) => document.querySelector(q);
    const ok = $('#msgOk'), err = $('#msgErr');
    const showOk  = (t)=>{ ok.textContent=t; ok.style.display='block'; };
    const showErr = (t)=>{ err.textContent=t; err.style.display='block'; };
    const clearMsgs = ()=>{ ok.style.display='none'; err.style.display='none'; ok.textContent=''; err.textContent=''; };

    // 2) Create/ensure trainer profile for given uid
    async function upsertTrainerProfile(uid, full_name) {
      // upsert profile with is_trainer + role
      const { error } = await sb.from('profiles').upsert({
        id: uid,
        full_name,
        role: 'trainer',
        is_trainer: true,
        trainer_id: uid
      }, { onConflict: 'id' });
      if (error) throw error;
    }

    // 3) Handle sign-up
    const form = document.getElementById('signupForm');
    const btn  = document.getElementById('submitBtn');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsgs();
      btn.disabled = true; btn.textContent = 'Creating…';

      try {
        const email = $('#email').value.trim();
        const password = $('#password').value;
        const full_name = $('#full_name').value.trim();

        // Create auth user (and sign in)
        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) throw error;

        const uid = data.user.id;

        // Upsert profile with trainer flags
        await upsertTrainerProfile(uid, full_name);

        showOk('Trainer account created! Redirecting to dashboard…');
        // If you require email confirmation, you might want to wait for confirmation.
        // For now we proceed straight to dashboard.
        setTimeout(()=> location.replace('trainer-dashboard.html'), 800);
      } catch (e) {
        console.error(e);
        if (String(e?.message || '').toLowerCase().includes('fetch')) {
          showErr('Sign‑up failed: network blocked (CORS/AdBlock/VPN) or offline. Try disabling extensions/VPN and reload.');
        } else {
          showErr('Sign‑up failed: ' + (e.message || e));
        }
      } finally {
        btn.disabled = false; btn.textContent = 'Create trainer account';
      }
    });

    // 4) Reset cached session
    document.getElementById('resetSession').addEventListener('click', async () => {
      clearMsgs();
      try {
        await sb.auth.signOut();
        Object.keys(localStorage).filter(k => k.startsWith('sb-')).forEach(k => localStorage.removeItem(k));
        showOk('Session cache cleared.');
      } catch (e) { showErr('Could not clear session: ' + (e.message||e)); }
    });
  </script>
</body>
</html>